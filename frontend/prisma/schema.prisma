// =============================================================================
// PRIMUS HOME PRO — CANONICAL PRISMA SCHEMA (Contract v1.0)
// =============================================================================
// This schema is the SINGLE SOURCE OF TRUTH for all database interactions.
// Do NOT add fields or models without explicit contract revision.
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// AGENT — Sales agents, schedulers, installers
// =============================================================================

model Agent {
  id      String  @id @default(cuid())
  clerkId String  @unique // Clerk auth user ID
  email   String  @unique
  name    String
  phone   String?
  role    String  @default("sales") // "admin", "sales", "scheduler", "installer"

  // Relations
  leads             Lead[]
  commissionUnlocks CommissionUnlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clerkId])
  @@index([email])
  @@index([role])
}

// =============================================================================
// LEAD — Potential customers
// =============================================================================

model Lead {
  id      String  @id @default(cuid())
  agentId String?
  agent   Agent?  @relation(fields: [agentId], references: [id])

  name    String?
  email   String?
  phone   String?
  address String?

  status String  @default("new") // "new", "qualified", "disqualified", "proposed", "sold"
  source String? // Form source (landing page, referral, etc.)

  // Relations
  solarQualification SolarQualification?
  proposals          Proposal[]
  project            Project?
  messages           Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([status])
  @@index([createdAt])
}

// =============================================================================
// SOLAR QUALIFICATION — Roof viability assessment (1:1 with Lead)
// =============================================================================

model SolarQualification {
  id     String @id @default(cuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Solar API Data
  roofAreaSqM       Float
  sunshineHoursYear Float
  shadingPercent    Float

  // Qualification Results (from domain logic)
  roofViable Boolean
  solarScore Int // 0-100
  confidence String // "high", "medium", "low"

  // Raw API Response
  rawApiData Json?

  createdAt DateTime @default(now())

  @@index([leadId])
  @@index([roofViable])
}

// =============================================================================
// PROPOSAL — Solar system proposals (1:N with Lead)
// =============================================================================

model Proposal {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Financial (domain-computed values stored here)
  totalSystemCost        Float
  netCostAfterIncentives Float
  estMonthlyPayment      Float
  estMonthlySavings      Float

  pricingMode String  @default("loan") // "loan", "cash", "ppa"
  pdfUrl      String?

  createdAt DateTime @default(now())

  @@index([leadId])
}

// =============================================================================
// PROJECT — Installation projects (1:1 with Lead, created when lead closes)
// =============================================================================

model Project {
  id     String @id @default(cuid())
  leadId String @unique
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  status String @default("active") // "active", "on_hold", "completed", "cancelled"

  // Relations
  milestones ProjectMilestone[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leadId])
  @@index([status])
}

// =============================================================================
// PROJECT MILESTONE — Project phase tracking (1:N with Project)
// =============================================================================

model ProjectMilestone {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  name        String // e.g., "Site Survey", "Contract Signed"
  unlockKey   String // e.g., "site_survey", "contract_signed" — links to commission
  description String?
  sortOrder   Int     @default(0)

  status      String    @default("pending") // "pending", "completed"
  completedAt DateTime?
  completedBy String? // Agent ID who completed

  // Relations
  commissionUnlocks CommissionUnlock[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([unlockKey])
}

// =============================================================================
// COMMISSION UNLOCK — Commission tracking (1:N with Milestone)
// =============================================================================

model CommissionUnlock {
  id          String           @id @default(cuid())
  milestoneId String
  milestone   ProjectMilestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  agentId     String
  agent       Agent            @relation(fields: [agentId], references: [id])

  unlockKey       String // Same as milestone.unlockKey for easy querying
  status          String @default("pending") // "pending", "confirmed", "paid"
  amountEstimated Float  @default(0)
  amountConfirmed Float  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([milestoneId])
  @@index([agentId])
  @@index([status])
  @@index([unlockKey])
}

// =============================================================================
// MESSAGE — Twilio inbound/outbound SMS (1:N with Lead)
// =============================================================================

model Message {
  id     String @id @default(cuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  direction         String // "inbound", "outbound"
  channel           String  @default("sms") // "sms", "email"
  body              String
  providerMessageId String?

  sentAt DateTime @default(now())

  @@index([leadId])
  @@index([direction])
  @@index([sentAt])
}

// =============================================================================
// AUTOMATION EVENT — Automation trigger history
// =============================================================================

model AutomationEvent {
  id     String @id @default(cuid())
  leadId String

  eventType   String // "no_reply_3d", "new_lead_flash", etc.
  triggeredAt DateTime
  handled     Boolean   @default(false)
  handledAt   DateTime?

  metadata Json?

  @@index([leadId])
  @@index([handled])
  @@index([triggeredAt])
}
